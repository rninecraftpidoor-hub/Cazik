<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Dice Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #1e1e2f, #2a2a40);
    color: white;
}
.screen { display:none; padding:20px; text-align:center; }
.active { display:block; }

button {
    background:#3b82f6;
    border:none;
    padding:14px 22px;
    margin:8px;
    color:white;
    font-size:16px;
    border-radius:999px;
}

.header { position:absolute; left:10px; top:10px; }

.loader {
    width:60px;height:60px;
    border:6px solid #ffffff30;
    border-top:6px solid white;
    border-radius:50%;
    margin:40px auto;
    animation:spin 1s linear infinite;
}
@keyframes spin {100%{transform:rotate(360deg);}}
.big{font-size:28px;margin:20px;}
</style>
</head>
<body>

<div id="menu" class="screen active">
    <h2>üé≤ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
    <button onclick="roll()">–ö–∏–Ω—É—Ç—å –∫—É–±–∏–∫–∏</button>
    <button onclick="openBag()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—à–æ–∫</button>
    <button onclick="openTop()">–¢–æ–ø</button>
    <button onclick="openLevel()">–£—Ä–æ–≤–µ–Ω—å</button>
</div>

<div id="loading" class="screen">
    <div class="loader"></div>
    <div>–ö—Ä—É—Ç–∏–º –∫—É–±–∏–∫–∏...</div>
</div>

<div id="result" class="screen">
    <div class="big" id="diceResult"></div>
    <div class="big" id="winResult"></div>
    <button onclick="takePrize()">–ó–∞–±—Ä–∞—Ç—å –ø—Ä–∏–∑</button>
</div>

<div id="bag" class="screen">
    <div class="header">
        <button onclick="back()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
    <h2>üëú –¢–≤–æ–π –º–µ—à–æ–∫</h2>
    <div class="big" id="bagAmount">0</div>
</div>

<div id="top" class="screen">
    <div class="header">
        <button onclick="back()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <h2>üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>

    <button onclick="showLocalTop()">–¢–æ–ø –≥—Ä—É–ø–ø—ã</button>
    <button onclick="showGlobalTop()">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–æ–ø</button>

    <div class="big" id="topResult">–í—ã–±–µ—Ä–∏ —Ç–∏–ø —Ç–æ–ø–∞</div>
</div>

<div id="level" class="screen">
    <div class="header">
        <button onclick="back()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <h2>‚≠ê –£—Ä–æ–≤–µ–Ω—å</h2>
    <div class="big" id="levelInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <button onclick="buyLevel()">–ö—É–ø–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCBahw3ayFaEiqB6QFv1D3xWms-c",
  authDomain: "cazik-959c0.firebaseapp.com",
  databaseURL: "https://cazik-959c0-default-rtdb.firebaseio.com",
  projectId: "cazik-959c0",
  storageBucket: "cazik-959c0.firebasestorage.app",
  messagingSenderId: "57672758285",
  appId: "1:57672758285:web:02243883937c7ff8c01144"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const tg = window.Telegram.WebApp;
tg.expand();

const user = tg.initDataUnsafe?.user;
const chat = tg.initDataUnsafe?.chat;

const userId = user?.id || "offline";
const username = user?.username || user?.first_name || "Player";
const chatId = chat?.id || "private";

let currentWin = 0;
let bag = 0;
let level = 1;
let multiplier = 1;

/* UI */
function show(id){
 document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
 document.getElementById(id).classList.add("active");
}
window.openBag=()=>show("bag");
window.openTop=()=>show("top");
window.openLevel=()=>{ show("level"); updateLevelUI(); };
window.back=()=>show("menu");

/* –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö */
async function loadBag(){
 const snap=await get(ref(db,"users/"+userId));
 if(snap.exists()){
   const data=snap.val();
   bag=data.bag||0;
   level=data.level||1;
   multiplier=data.multiplier||1;
 }else{
   await set(ref(db,"users/"+userId),{
     name:username,
     bag:0,
     total:0,
     level:1,
     multiplier:1
   });
 }

 document.getElementById("bagAmount").innerText=bag;
 updateLevelUI();
}
loadBag();

/* –ö—É–±–∏–∫–∏ */
window.roll=()=>{
 show("loading");
 setTimeout(()=>{
  let d1=Math.floor(Math.random()*6)+1;
  let d2=Math.floor(Math.random()*6)+1;

  currentWin=Math.floor((d1+d2)*5*multiplier);

  document.getElementById("diceResult").innerText=`–í—ã–ø–∞–ª–æ: ${d1} –∏ ${d2}`;
  document.getElementById("winResult").innerText=`–¢—ã –≤—ã–∏–≥—Ä–∞–ª: ${currentWin}`;
  show("result");
 },1500);
};

/* –ó–∞–±—Ä–∞—Ç—å –ø—Ä–∏–∑ */
window.takePrize=async()=>{
 bag+=currentWin;

 await update(ref(db,"users/"+userId),{
   name:username,
   bag:bag,
   level:level,
   multiplier:multiplier,
   total:(await getTotal())+currentWin
 });

 await update(ref(db,"groups/"+chatId+"/"+userId),{
   name:username,
   total:(await getLocalTotal())+currentWin
 });

 document.getElementById("bagAmount").innerText=bag;
 currentWin=0;
 show("menu");
};

async function getTotal(){
 const s=await get(ref(db,"users/"+userId+"/total"));
 return s.exists()?s.val():0;
}

async function getLocalTotal(){
 const s=await get(ref(db,"groups/"+chatId+"/"+userId+"/total"));
 return s.exists()?s.val():0;
}

/* –¢–û–ü–´ */
window.showGlobalTop=async()=>{
 const snap=await get(ref(db,"users"));
 let list=[];
 snap.forEach(u=>{
   const d=u.val();
   list.push({name:d.name,total:d.total||0});
 });
 list.sort((a,b)=>b.total-a.total);

 let text="";
 list.slice(0,10).forEach((p,i)=>{
   text+=`${i+1}. ${p.name} ‚Äî ${p.total}\n`;
 });

 document.getElementById("topResult").innerText=text||"–ü—É—Å—Ç–æ";
};

window.showLocalTop=async()=>{
 const snap=await get(ref(db,"groups/"+chatId));
 let list=[];
 snap.forEach(u=>{
   const d=u.val();
   list.push({name:d.name,total:d.total||0});
 });
 list.sort((a,b)=>b.total-a.total);

 let text="";
 list.slice(0,10).forEach((p,i)=>{
   text+=`${i+1}. ${p.name} ‚Äî ${p.total}\n`;
 });

 document.getElementById("topResult").innerText=text||"–ü—É—Å—Ç–æ";
};

/* –£–†–û–í–ù–ò */
function levelPrice(){
 return level*250;
}

function updateLevelUI(){
 const el=document.getElementById("levelInfo");
 if(!el) return;

 el.innerText=
`–£—Ä–æ–≤–µ–Ω—å: ${level}
–ú–Ω–æ–∂–∏—Ç–µ–ª—å: x${multiplier.toFixed(1)}
–¶–µ–Ω–∞: ${levelPrice()}
–ë–∞–ª–∞–Ω—Å: ${bag}`;
}

window.buyLevel=async()=>{
 const price=levelPrice();
 if(bag<price){
   alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥");
   return;
 }

 bag-=price;
 level++;

 if(level%2===0) multiplier+=0.2;
 if(level%5===0) multiplier+=0.5;

 await update(ref(db,"users/"+userId),{
   bag:bag,
   level:level,
   multiplier:multiplier
 });

 document.getElementById("bagAmount").innerText=bag;
 updateLevelUI();
};
</script>
</body>
</html>
```Ó®Å0Ó®Ç
