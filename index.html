<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Dice Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #1e1e2f, #2a2a40);
    color: white;
}
.screen { display:none; padding:20px; text-align:center; }
.active { display:block; }

button {
    background:#3b82f6;
    border:none;
    padding:14px 22px;
    margin:8px;
    color:white;
    font-size:16px;
    border-radius:999px;
}

input{
    padding:12px;
    border-radius:12px;
    border:none;
    margin:8px;
    width:150px;
    text-align:center;
}

.header { position:absolute; left:10px; top:10px; }

.loader {
    width:60px;height:60px;
    border:6px solid #ffffff30;
    border-top:6px solid white;
    border-radius:50%;
    margin:40px auto;
    animation:spin 1s linear infinite;
}
@keyframes spin {100%{transform:rotate(360deg);}}
.big{font-size:28px;margin:20px;}
</style>
</head>
<body>

<!-- ========== –ú–ï–ù–Æ ========== -->
<div id="menu" class="screen active">
    <h2>üé≤ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
    <input id="bet" type="number" placeholder="–°—Ç–∞–≤–∫–∞">
    <input id="promoInput" type="text" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥">
    <button onclick="usePromo()">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
    <br>
    <button onclick="roll()">–ö–∏–Ω—É—Ç—å –∫—É–±–∏–∫–∏</button>
    <button onclick="openBag()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—à–æ–∫</button>
    <button onclick="openTop()">–¢–æ–ø</button>
    <button onclick="openLevel()">–£—Ä–æ–≤–µ–Ω—å</button>
    <button onclick="openTrades()">–¢—Ä–µ–π–¥—ã</button>
</div>

<!-- ========== –ó–ê–ì–†–£–ó–ö–ê ========== -->
<div id="loading" class="screen">
    <div class="loader"></div>
    <div>–ö—Ä—É—Ç–∏–º –∫—É–±–∏–∫–∏...</div>
</div>

<!-- ========== –†–ï–ó–£–õ–¨–¢–ê–¢ ========== -->
<div id="result" class="screen">
    <div class="big" id="diceResult"></div>
    <div class="big" id="winResult"></div>
    <button onclick="takePrize()">–ó–∞–±—Ä–∞—Ç—å –ø—Ä–∏–∑</button>
</div>

<!-- ========== –ú–ï–®–û–ö ========== -->
<div id="bag" class="screen">
    <div class="header">
        <button onclick="back()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
    <h2>üëú –¢–≤–æ–π –º–µ—à–æ–∫</h2>
    <div class="big" id="bagAmount">0</div>
</div>

<!-- ========== –¢–û–ü ========== -->
<div id="top" class="screen">
    <div class="header">
        <button onclick="back()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
    <h2>üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>
    <button onclick="showLocalTop()">–¢–æ–ø –≥—Ä—É–ø–ø—ã</button>
    <button onclick="showGlobalTop()">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–æ–ø</button>
    <div class="big" id="topResult">–í—ã–±–µ—Ä–∏ —Ç–∏–ø —Ç–æ–ø–∞</div>
</div>

<!-- ========== –£–†–û–í–ï–ù–¨ ========== -->
<div id="level" class="screen">
    <div class="header">
        <button onclick="back()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
    <h2>‚≠ê –£—Ä–æ–≤–µ–Ω—å</h2>
    <div class="big" id="levelInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <button onclick="buyLevel()">–ö—É–ø–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
</div>

<!-- ========== –¢–†–ï–ô–î–´ ========== -->
<div id="trades" class="screen">
    <div class="header">
        <button onclick="back()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
    <h2>üí± –¢—Ä–µ–π–¥—ã</h2>

    <button id="tradeToggleBtn" style="margin-bottom:12px;">–¢—Ä–µ–π–¥—ã –≤–∫–ª—é—á–µ–Ω—ã</button>

    <div style="margin-top:12px;">
        <input id="tradeUser" type="text" placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º –∏–≥—Ä–æ–∫–∞">
        <input id="tradeAmount" type="number" placeholder="–°—É–º–º–∞">
        <button id="tradeSendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–µ–π–¥</button>
    </div>

    <div id="tradeResult" class="big" style="margin-top:20px;"></div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCBahw3ayFaEiqB6QFv1D3xWms-c",
  authDomain: "cazik-959c0.firebaseapp.com",
  databaseURL: "https://cazik-959c0-default-rtdb.firebaseio.com",
  projectId: "cazik-959c0",
  storageBucket: "cazik-959c0.firebasestorage.app",
  messagingSenderId: "57672758285",
  appId: "1:57672758285:web:02243883937c7ff8c01144"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Telegram Web App
const tg = window.Telegram.WebApp;
tg.expand();

const user = tg.initDataUnsafe?.user;
const chat = tg.initDataUnsafe?.chat;

const userId = user?.id || "offline";
const username = user?.username || user?.first_name || "Player";
const chatId = chat?.id || "private";

let currentWin = 0;
let bag = 0;
let level = 1;
let multiplier = 1;
let tradeEnabled = true;

/* ===== UI ===== */
function show(id){
 document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
 document.getElementById(id).classList.add("active");
}
window.openBag = () => show("bag");
window.openTop = () => show("top");
window.openLevel = () => { show("level"); updateLevelUI(); };
window.openTrades = () => show("trades");
window.back = () => show("menu");

/* ===== –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ===== */
async function loadBag(){
 const snap = await get(ref(db,"users/"+userId));
 if(snap.exists()){
   const data = snap.val();
   bag = data.bag || 0;
   level = data.level || 1;
   multiplier = data.multiplier || 1;
 } else {
   await set(ref(db,"users/"+userId),{
     name: username,
     bag: 0,
     total: 0,
     level: 1,
     multiplier: 1
   });
 }
 document.getElementById("bagAmount").innerText = bag;
 updateLevelUI();
}
loadBag();

/* ===== –¢–†–ï–ô–î–´ ===== */
function toggleTrades() {
    tradeEnabled = !tradeEnabled;
    document.getElementById("tradeStatus").innerText = tradeEnabled ? "–¢—Ä–µ–π–¥—ã –≤–∫–ª—é—á–µ–Ω—ã" : "–¢—Ä–µ–π–¥—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã";
}

async function sendTrade() {
    if(!tradeEnabled){ 
        alert("–¢—Ä–µ–π–¥—ã —Å–µ–π—á–∞—Å –æ—Ç–∫–ª—é—á–µ–Ω—ã"); 
        return; 
    }

    const targetName = document.getElementById("tradeUser").value.trim();
    const amount = Number(document.getElementById("tradeAmount").value);

    if(!targetName || !amount || amount <= 0){ 
        alert("–í–≤–µ–¥–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –∏ —Å—É–º–º—É"); 
        return; 
    }

    if(amount > bag){ 
        alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥"); 
        return; 
    }

    // –ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–∞ –≤ –≥—Ä—É–ø–ø–µ
    const groupSnap = await get(ref(db,"groups/"+chatId));
    let targetId = null;
    groupSnap.forEach(u => {
        if(u.val().name.toLowerCase().trim() === targetName.toLowerCase()) targetId = u.key;
    });

    if(!targetId){ 
        alert("–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω"); 
        return; 
    }

    try {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        const targetSnap = await get(ref(db,"users/"+targetId));
        let targetBag = targetSnap.exists() ? (targetSnap.val().bag||0) : 0;

        // –°–ø–∏—Å–∞–Ω–∏–µ —É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        bag -= amount;
        await update(ref(db,"users/"+userId), { bag: bag });

        // –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —É –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        await update(ref(db,"users/"+targetId), { bag: targetBag + amount });

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        document.getElementById("bagAmount").innerText = bag;
        document.getElementById("tradeResult").innerText = `‚úÖ –¢—Ä–µ–π–¥ —É—Å–ø–µ—à–Ω–æ: ${amount} ‚Üí ${targetName}`;

        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        document.getElementById("tradeUser").value = "";
        document.getElementById("tradeAmount").value = "";
    } catch(err){
        alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç—Ä–µ–π–¥–∞. –î–µ–Ω—å–≥–∏ –Ω–µ —Å–ø–∏—Å–∞–Ω—ã.");
        console.error(err);
    }
}
/* ===== –ö–ê–ó–ò–ù–û ===== */
window.roll = async() => {
 const bet = Number(document.getElementById("bet").value);

 if(!bet||bet<=0){ alert("–í–≤–µ–¥–∏ —Å—Ç–∞–≤–∫—É"); return; }
 if(bet>bag){ alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥"); return; }

 bag -= bet;
 document.getElementById("bagAmount").innerText = bag;

 const totalNow = await getTotal();
 const localNow = await getLocalTotal();

 await update(ref(db,"users/"+userId),{
   bag: bag,
   total: totalNow - bet
 });

 await update(ref(db,"groups/"+chatId+"/"+userId),{
   name: username,
   total: localNow - bet
 });

 show("loading");

 setTimeout(()=>{
  let d1 = Math.floor(Math.random()*6)+1;
  let d2 = Math.floor(Math.random()*6)+1;
  let sum = d1 + d2;

  if(sum<=6){
    currentWin = 0;
    document.getElementById("winResult").innerText = "–ü—Ä–æ–∏–≥—Ä—ã—à üíÄ";
  } else if(sum<=9){
    currentWin = Math.floor(bet*1.5*multiplier);
    document.getElementById("winResult").innerText = `–í—ã–∏–≥—Ä—ã—à: ${currentWin}`;
  } else {
    currentWin = Math.floor(bet*2.2*multiplier);
    document.getElementById("winResult").innerText = `–ö–†–£–ü–ù–´–ô –í–´–ò–ì–†–´–®: ${currentWin}`;
  }

  document.getElementById("diceResult").innerText = `–í—ã–ø–∞–ª–æ: ${d1} –∏ ${d2}`;
  show("result");
 },1500);
};

window.takePrize = async() => {
 bag += currentWin;

 await update(ref(db,"users/"+userId),{
   name: username,
   bag: bag,
   level: level,
   multiplier: multiplier,
   total: (await getTotal()) + currentWin
 });

 await update(ref(db,"groups/"+chatId+"/"+userId),{
   name: username,
   total: (await getLocalTotal()) + currentWin
 });

 document.getElementById("bagAmount").innerText = bag;
 currentWin = 0;
 show("menu");
};

async function getTotal() {
 const s = await get(ref(db,"users/"+userId+"/total"));
 return s.exists()? s.val() : 0;
}

async function getLocalTotal() {
 const s = await get(ref(db,"groups/"+chatId+"/"+userId+"/total"));
 return s.exists()? s.val() : 0;
}

/* ===== –¢–û–ü–´ ===== */
window.showGlobalTop = async() => {
 const snap = await get(ref(db,"users"));
 let list = [];
 snap.forEach(u => { list.push({name:u.val().name, total:u.val().total||0}); });
 list.sort((a,b)=>b.total-a.total);

 let text = "";
 list.slice(0,10).forEach((p,i)=>{ text += `${i+1}. ${p.name} ‚Äî ${p.total}\n`; });
 document.getElementById("topResult").innerText = text || "–ü—É—Å—Ç–æ";
};

window.showLocalTop = async() => {
 const snap = await get(ref(db,"groups/"+chatId));
 let list = [];
 snap.forEach(u => { list.push({name:u.val().name, total:u.val().total||0}); });
 list.sort((a,b)=>b.total-a.total);

 let text = "";
 list.slice(0,10).forEach((p,i)=>{ text += `${i+1}. ${p.name} ‚Äî ${p.total}\n`; });
 document.getElementById("topResult").innerText = text || "–ü—É—Å—Ç–æ";
};

/* ===== –ü–†–û–ú–û–ö–û–î–´ ===== */
window.usePromo = async () => {
    const code = document.getElementById("promoInput").value.trim().toUpperCase();
    if (!code) return;

    const promoRef = ref(db, "users/" + userId + "/promos/" + code);
    const usedSnap = await get(promoRef);

    let reward = 0;
    let subtract = false;
    let reset = false;
    let message = "";

    switch(code){
        // --- –°—Ç–∞—Ä—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã ---
        case "BATEK":
            if(usedSnap.exists()){ alert("–£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω"); return; }
            reward = 501;
            await set(promoRef, true);
            break;
        case "KOSTYA":
            if(usedSnap.exists()){ alert("–£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω"); return; }
            reward = 750;
            await set(promoRef, true);
            break;
        case "ANAL":
            if(String(userId) !== "1842907087"){ alert("–ù–µ –¥–ª—è —Ç–µ–±—è"); return; }
            reward = 100000000000000000000000000000000;
            break;

        // --- –ù–æ–≤—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã ---
        case "ALANGAY":
            subtract = true;
            reward = 1488;
            break;
        case "OXYWORLD":
            reward = 50;
            break;
        case "LAGAETSTANDOFF":
            reward = 600;
            break;
        case "YOUAREANIDIOT":
            subtract = true;
            reward = 500;
            break;
        case "BUILDABOAT":
            reward = 150000;
            break;
        case "QO9_XCO12(YOUMIGHTBEDIED)":
            reward = 50000;
            break;
        case "SKILEWOKER":
            subtract = true;
            reward = 100000;
            break;
        case "DANILKOLBASENKO":
            reward = 3000;
            break;
        case "SALIM":
            reward = 1;
            break;
        case "HOWDIDYOUFINDTHIS":
            alert("–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –∫–∞–∫ —Ç—ã –Ω–∞—à–µ–ª —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥, –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –µ–≥–æ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è...");
            return;
        case "RESET":
            reset = true;
            break;
        case "RESET2":
            reset = true;
            reward = 250;
            break;
        case "h7K2mP9nB5vR1xQ8zW4jL0fT6sY3uG9aC1eI5oD8kM2tN4pZ7gH0sX3wF5bV9rQ1":
            reward = 1000000;
            break;

        default:
            alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥");
            return;
    }

    if(reset){
        bag = 0;
        level = 1;
        multiplier = 1;
        await update(ref(db,"users/"+userId), { bag, level, multiplier });
        if(reward > 0) bag += reward;
        message = `–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω${reward>0 ? `, –ø–æ–ª—É—á–µ–Ω–æ ${reward}` : ""}`;
    } else {
        if(subtract) bag -= reward;
        else bag += reward;
        message = subtract ? `–°–ø–∏—Å–∞–Ω–æ: ${reward}` : `–ü–æ–ª—É—á–µ–Ω–æ: ${reward}`;
        await update(ref(db,"users/"+userId), { bag });
        if(!subtract && !["BATEK","KOSTYA","ANAL"].includes(code)){
            await set(promoRef, true); // –æ—Ç–º–µ—á–∞–µ–º –Ω–æ–≤—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–∞—é—Ç –º–æ–Ω–µ—Ç—ã
        }
    }

    document.getElementById("bagAmount").innerText = bag;
    alert(message);
};
/* ===== –£–†–û–í–ù–ò ===== */
function levelPrice(){ return level*250; }

function updateLevelUI(){
 const el = document.getElementById("levelInfo");
 if(!el) return;

 el.innerText=
`–£—Ä–æ–≤–µ–Ω—å: ${level}
–ú–Ω–æ–∂–∏—Ç–µ–ª—å: x${multiplier.toFixed(1)}
–¶–µ–Ω–∞: ${levelPrice()}
–ë–∞–ª–∞–Ω—Å: ${bag}`;
}

window.buyLevel = async() => {
 const price = levelPrice();
 if(bag < price){ alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥"); return; }

 bag -= price;
 level++;

 if(level % 2 === 0) multiplier += 0.2;
 if(level % 5 === 0) multiplier += 0.5;

 await update(ref(db,"users/"+userId),{
   bag: bag,
   level: level,
   multiplier: multiplier
 });

 document.getElementById("bagAmount").innerText = bag;
 updateLevelUI();
};
</script>

</body>
</html>
