<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Dice Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #1e1e2f, #2a2a40);
    color: white;
}

.screen {
    display: none;
    padding: 20px;
    text-align: center;
}

.active {
    display: block;
}

button {
    background: #3b82f6;
    border: none;
    padding: 14px 22px;
    margin: 8px;
    color: white;
    font-size: 16px;
    border-radius: 999px;
    cursor: pointer;
}

button:hover {
    background: #2563eb;
}

.header {
    position: absolute;
    left: 10px;
    top: 10px;
}

.loader {
    width: 60px;
    height: 60px;
    border: 6px solid #ffffff30;
    border-top: 6px solid white;
    border-radius: 50%;
    margin: 40px auto;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    100% { transform: rotate(360deg); }
}

.big {
    font-size: 28px;
    margin: 20px;
}
</style>
</head>
<body>

<!-- –ú–ï–ù–Æ -->
<div id="menu" class="screen active">
    <h2>üé≤ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
    <button onclick="roll()">–ö–∏–Ω—É—Ç—å –∫—É–±–∏–∫–∏</button>
    <button onclick="openBag()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—à–æ–∫</button>
    <button onclick="openTop()">–¢–æ–ø</button>
</div>

<!-- –ó–ê–ì–†–£–ó–ö–ê -->
<div id="loading" class="screen">
    <div class="loader"></div>
    <div>–ö—Ä—É—Ç–∏–º –∫—É–±–∏–∫–∏...</div>
</div>

<!-- –†–ï–ó–£–õ–¨–¢–ê–¢ -->
<div id="result" class="screen">
    <div class="big" id="diceResult"></div>
    <div class="big" id="winResult"></div>
    <button onclick="takePrize()">–ó–∞–±—Ä–∞—Ç—å –ø—Ä–∏–∑</button>
</div>

<!-- –ú–ï–®–û–ö -->
<div id="bag" class="screen">
    <div class="header">
        <button onclick="back()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
    <h2>üëú –¢–≤–æ–π –º–µ—à–æ–∫</h2>
    <div class="big" id="bagAmount"></div>
</div>

<!-- –¢–û–ü -->
<!-- –¢–û–ü -->
<div id="top" class="screen">
    <div class="header">
        <button onclick="back()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <h2>üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>

    <button onclick="showLocalTop()">–¢–æ–ø –≥—Ä—É–ø–ø—ã</button>
    <button onclick="showGlobalTop()">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–æ–ø</button>

    <div class="big" id="topResult">–í—ã–±–µ—Ä–∏ —Ç–∏–ø —Ç–æ–ø–∞</div>
</div>
<script>
let currentWin = 0;

function show(id) {
    document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
}

function getBag() {
    return Number(localStorage.getItem("bag")) || 0;
}

function setBag(value) {
    localStorage.setItem("bag", value);
}

function roll() {
    show("loading");

    setTimeout(() => {
        let d1 = Math.floor(Math.random()*6)+1;
        let d2 = Math.floor(Math.random()*6)+1;
        currentWin = (d1 + d2) * 5;

        document.getElementById("diceResult").innerText =
            `–í—ã–ø–∞–ª–æ: ${d1} –∏ ${d2}`;

        document.getElementById("winResult").innerText =
            `–¢—ã –≤—ã–∏–≥—Ä–∞–ª: ${currentWin}`;

        show("result");
    }, 1800);
}

function takePrize() {
    let total = getBag() + currentWin;
    setBag(total);
    currentWin = 0;
    show("menu");
}

function openBag() {
    document.getElementById("bagAmount").innerText =
        "–í—Å–µ–≥–æ: " + getBag();
    show("bag");
}

function openTop() {
    show("top");
}

function back() {
    show("menu");
}
</script>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
const tg = window.Telegram.WebApp;

tg.expand();

const user = tg.initDataUnsafe?.user;
const chat = tg.initDataUnsafe?.chat;

let userId = user?.id || "offline";
let username = user?.username || user?.first_name || "Player";
let chatId = chat?.id || "private";

console.log("USER:", userId, username);
console.log("CHAT:", chatId);
</script>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCBahw3ayFaEiqB6QFv1D3xWms-c",
  authDomain: "cazik-959c0.firebaseapp.com",
  databaseURL: "https://cazik-959c0-default-rtdb.firebaseio.com",
  projectId: "cazik-959c0",
  storageBucket: "cazik-959c0.firebasestorage.app",
  messagingSenderId: "57672758285",
  appId: "1:57672758285:web:02243883937c7ff8c01144"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const tg = window.Telegram.WebApp;
tg.expand();

const user = tg.initDataUnsafe?.user;

let userId = user?.id || "offline";
let username = user?.username || user?.first_name || "Player";

let balance = 0;

// –ó–ê–ì–†–£–ó–ö–ê –ú–ï–®–ö–ê
async function loadBalance() {
  const snapshot = await get(ref(db, "users/" + userId));
  if (snapshot.exists()) {
    balance = snapshot.val().balance || 0;
  } else {
    await set(ref(db, "users/" + userId), {
      name: username,
      balance: 0
    });
    balance = 0;
  }

  updateBag();
}

// –°–û–•–†–ê–ù–ï–ù–ò–ï
async function saveBalance() {
  await update(ref(db, "users/" + userId), {
    balance: balance
  });
}

// –ü–û–ö–ê–ó –í –ú–ï–®–ö–ï
function updateBag() {
  const el = document.getElementById("bagAmount");
  if (el) el.innerText = balance;
}

// –í–´–ò–ì–†–´–®
function addWin(amount) {
  balance += amount;
  updateBag();
  saveBalance();
}

window.addWin = addWin;

loadBalance();
</script>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* --- FIREBASE --- */
const firebaseConfig = {
  apiKey: "–¢–í–û–ô_API_KEY",
  authDomain: "–¢–í–û–ô_DOMAIN",
  databaseURL: "–¢–í–û–ô_DATABASE_URL",
  projectId: "–¢–í–û–ô_PROJECT_ID",
  storageBucket: "–¢–í–û–ô_BUCKET",
  messagingSenderId: "–¢–í–û–ô_ID",
  appId: "–¢–í–û–ô_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* --- TELEGRAM DATA --- */
const tg = window.Telegram.WebApp;
tg.expand();

const user = tg.initDataUnsafe?.user;
const chat = tg.initDataUnsafe?.chat;

const userId = user?.id || "offline";
const username = user?.username || user?.first_name || "Player";
const chatId = chat?.id || "private";

/* --- –ë–ê–õ–ê–ù–° (–ú–ï–®–û–ö) --- */
let bag = 0;

async function loadBag() {
  const snapshot = await get(ref(db, "users/" + userId));
  if (snapshot.exists()) {
    bag = snapshot.val().bag || 0;
  }
  document.getElementById("bagAmount").innerText = bag;
}

async function saveWin(amount) {
  bag += amount;

  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–ª–∞–Ω—Å
  await update(ref(db, "users/" + userId), {
    name: username,
    bag: bag,
    total: (await getTotal()) + amount
  });

  // –ª–æ–∫–∞–ª—å–Ω—ã–π —Ç–æ–ø
  await update(ref(db, "groups/" + chatId + "/" + userId), {
    name: username,
    total: (await getLocalTotal()) + amount
  });

  document.getElementById("bagAmount").innerText = bag;
}

async function getTotal() {
  const s = await get(ref(db, "users/" + userId + "/total"));
  return s.exists() ? s.val() : 0;
}

async function getLocalTotal() {
  const s = await get(ref(db, "groups/" + chatId + "/" + userId + "/total"));
  return s.exists() ? s.val() : 0;
}

/* --- –ü–û–ö–ê–ó –¢–û–ü–û–í --- */
async function showGlobalTop() {
  const snap = await get(ref(db, "users"));
  let list = [];

  snap.forEach(u => {
    const data = u.val();
    list.push({ name: data.name, total: data.total || 0 });
  });

  list.sort((a,b)=>b.total-a.total);

  let text = "üèÜ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–æ–ø\n\n";
  list.slice(0,10).forEach((p,i)=>{
    text += `${i+1}. ${p.name} ‚Äî ${p.total}\n`;
  });

  alert(text);
}

async function showLocalTop() {
  const snap = await get(ref(db, "groups/" + chatId));
  let list = [];

  snap.forEach(u => {
    const data = u.val();
    list.push({ name: data.name, total: data.total || 0 });
  });

  list.sort((a,b)=>b.total-a.total);

  let text = "üë• –¢–æ–ø –≥—Ä—É–ø–ø—ã\n\n";
  list.slice(0,10).forEach((p,i)=>{
    text += `${i+1}. ${p.name} ‚Äî ${p.total}\n`;
  });

  alert(text);
}

window.saveWin = saveWin;
window.showGlobalTop = showGlobalTop;
window.showLocalTop = showLocalTop;
window.onload = loadBag;
</script>

<script>
async function showGlobalTop() {
    const snapshot = await db.ref("players").orderByChild("total").limitToLast(10).once("value");

    let text = "";
    snapshot.forEach(child => {
        const data = child.val();
        text = `${data.name}: ${data.total}\n` + text;
    });

    document.getElementById("topList").innerText = text || "–ü–æ–∫–∞ –ø—É—Å—Ç–æ";
}

async function showLocalTop() {
    const chatId = Telegram.WebApp.initDataUnsafe?.chat?.id || "private";

    const snapshot = await db.ref("groups/" + chatId).orderByChild("total").limitToLast(10).once("value");

    let text = "";
    snapshot.forEach(child => {
        const data = child.val();
        text = `${data.name}: ${data.total}\n` + text;
    });

    document.getElementById("topList").innerText = text || "–ü–æ–∫–∞ –ø—É—Å—Ç–æ";
}
</script>

function openTop() {
    hideAll();
    document.getElementById('top').classList.add('active');
}

<script>
function showLocalTop() {
    document.getElementById("topResult").innerText =
        "–¢–æ–ø –≥—Ä—É–ø–ø—ã —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è";
}

function showGlobalTop() {
    document.getElementById("topResult").innerText =
        "–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–æ–ø —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è";
}
</script>
    
</body>
</html>
